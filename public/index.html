<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CabinCrew</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/aviator-game.css">
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>
  <div class="background-video-container">
    <video autoplay muted loop id="background-video">
      <source src="asset/video/airplane2.mp4" type="video/mp4">
    </video>
  </div>
  <script>
    // Nascondi il video quando si apre la game room
    document.addEventListener('DOMContentLoaded', function() {
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            const gameRoom = document.getElementById('game-room-screen');
            const videoContainer = document.querySelector('.background-video-container');
            
            if (gameRoom && !gameRoom.classList.contains('hidden')) {
              videoContainer.style.display = 'none';
            } else {
              videoContainer.style.display = 'block';
            }
          }
        });
      });
      
      const gameRoom = document.getElementById('game-room-screen');
      if (gameRoom) {
        observer.observe(gameRoom, { attributes: true });
      }
    });
  </script>
  <div id="app">
    <!-- Auth Screen -->
    <div id="auth-screen" class="screen">
      <div class="container">
        <div class="logo-container">
          <img src="/asset/images/logo/cabincrew-logo.png" alt="CabinCrew Logo" class="logo-image">
        </div>
        <div class="auth-tabs">
          <button id="login-tab" class="auth-tab active">Accedi</button>
          <button id="register-tab" class="auth-tab">Registrati</button>
        </div>
        <!-- Login Form -->
        <div id="login-form" class="auth-form">
          <h2>Accedi</h2>
          <input type="email" id="login-email" placeholder="Email" required>
          <input type="password" id="login-password" placeholder="Password" required>
          <button id="login-button" class="auth-button">Accedi</button>
          <p class="auth-footer">Non hai un account? <a href="#" id="switch-to-register">Registrati</a></p>
        </div>
        <!-- Register Form -->
        <div id="register-form" class="auth-form hidden">
          <h2>Registrati</h2>
          <input type="text" id="register-username" placeholder="Username" required>
          <input type="email" id="register-email" placeholder="Email" required>
          <input type="password" id="register-password" placeholder="Password" required>
          <input type="password" id="register-confirm-password" placeholder="Conferma Password" required>
          <button id="register-button" class="auth-button">Registrati</button>
          <p class="auth-footer">Hai gi√† un account? <a href="#" id="switch-to-login">Accedi</a></p>
        </div>
      </div>
    </div>
    
    <!-- Lobby Screen -->
    <div id="lobby-screen" class="screen hidden">
      <div class="container">
        <div class="lobby-header">
            <div class="logo-container lobby-logo">
              <img src="/asset/images/logo/cabincrew-logo.png" alt="CabinCrew Logo" class="logo-image">
            </div>
            <div class="user-controls">
              <button id="mute-button" class="mute-button">
                <span id="mute-icon">üîä</span>
              </button>
              <div id="user-profile-card" class="user-profile-card">
                <div class="user-badge">
                  <img id="selected-badge-icon" src="/asset/images/badges/default-badge.png" alt="Badge">
                </div>
                <div id="username-display">Username</div>
              </div>
            </div>
          </div>

        <div class="lobby-options">
          <div class="option-box">
            <h2>Create Room</h2>
            <div class="input-with-tooltip">
              <input type="text" id="room-name" placeholder="Room Name" required>
            </div>
            <div class="input-with-tooltip">
              <input type="number" id="room-code" placeholder="Room Code (numbers only)" required>
              <div class="tooltip">This code will be used by other players to join your room</div>
            </div>
            <div class="input-with-tooltip">
              <input type="number" id="initial-credits" placeholder="Initial Credits" value="10" min="1" max="100" step="0.1">
              <div class="tooltip">Amount of credits each player starts with</div>
            </div>
            <div class="input-with-tooltip">
              <input type="number" id="round-count" placeholder="Number of Rounds" value="5" min="1" max="20">
              <div class="tooltip">Total number of game rounds before determining the winner</div>
            </div>
            <button id="create-room-button">Create Room</button>
          </div>
          <div class="option-box">
            <h2>Join Room</h2>
            <div class="input-with-tooltip">
              <input type="number" id="join-room-code" placeholder="Enter Room Code" required>
              <div class="tooltip">Enter the code provided by the room creator</div>
            </div>
            <button id="join-room-button">Join Room</button>
          </div>
        </div>
      </div>

      <!-- Profile Overlay -->
      <div id="profile-overlay" class="overlay hidden">
        <div class="overlay-content">
          <div class="overlay-header">
            <h2>Your Profile</h2>
            <button class="close-overlay">√ó</button>
          </div>
          
          <div class="tabs">
            <button class="tab-button active" data-tab="profile-tab">Profile</button>
            <button class="tab-button" data-tab="friends-tab">Friends</button>
          </div>
          
          <div id="profile-tab" class="tab-content">
            <div class="profile-info">
              <div class="profile-header">
                <div class="username-container">
                  <div id="profile-tab-username">Username</div>
                  <button id="edit-username-button-overlay" class="edit-button">
                    <span>‚úèÔ∏è</span>
                  </button>
                </div>
                <div id="selected-badge">No Badge</div>
              </div>
              <div class="stats-container">
                <div class="stat-item">
                  <span class="stat-label">Total Games:</span>
                  <span id="total-games" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Highest Multiplier:</span>
                  <span id="highest-multiplier" class="stat-value">1.00x</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Games Won:</span>
                  <span id="games-won" class="stat-value">0</span>
                </div>
              </div>
              <div class="badges-container">
                <h3>I tuoi Badge</h3>
                <p class="badge-description">Seleziona un badge da mostrare nel tuo profilo</p>
                <div id="badges-list" class="badges-grid">
                  <!-- I badge verranno aggiunti dinamicamente -->
                </div>
              </div>
          </div>
          
          <div id="friends-tab" class="tab-content hidden">
            <div class="friends-search">
              <input type="text" id="friend-search" placeholder="Search username">
              <button id="add-friend-button">Add Friend</button>
            </div>
            <div class="friends-list">
              <h3>Your Friends</h3>
              <div id="friends-container">
                <!-- Friends will be populated here -->
                <div class="no-friends-message">You haven't added any friends yet.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Game Room Screen -->
<div id="game-room-screen" class="screen hidden">
  <div class="aviator-container">
    <!-- Header con info stanza e moltiplicatori precedenti -->
    <div class="room-header">
      <div class="room-info">
        <h2 id="room-title">Room Name</h2>
        <div class="room-details">
          <span id="round-info">Round 0/5</span>
          <span id="room-code-display">Code: 0000</span>
        </div>
      </div>
      <div class="previous-multipliers">
        <div class="prev-mult">1.52x</div>
        <div class="prev-mult">2.72x</div>
        <div class="prev-mult high">10.35x</div>
        <div class="prev-mult">1.12x</div>
        <div class="prev-mult">4.23x</div>
        <div class="prev-mult">1.89x</div>
        <div class="prev-mult medium">5.64x</div>
        <div class="prev-mult">1.22x</div>
      </div>
    </div>

    <!-- Layout principale a due colonne -->
    <div class="game-layout">
      <!-- Colonna sinistra -->
      <div class="left-column">
        <!-- Sezione scommesse attuali -->
        <div class="bets-section">
          <div class="section-header">
            <h3>Scommesse Round</h3>
          </div>
          <div class="bets-list" id="current-bets">
            <!-- Le scommesse verranno popolate dinamicamente -->
          </div>
        </div>
        
        <!-- Classifica generale -->
        <div class="rankings-section">
          <div class="section-header">
            <h3>Classifica</h3>
          </div>
          <div class="rankings-list" id="player-rankings">
            <!-- La classifica verr√† popolata dinamicamente -->
          </div>
        </div>
      </div>
      
      <!-- Area centrale del gioco -->
      <div class="game-area">
        <!-- Visualizzazione del moltiplicatore -->
        <div class="multiplier-display">
          <div class="multiplier-value" id="multiplier-display">1.00x</div>
          <div class="airplane-animation">
            <div class="airplane-container">
              <div class="airplane">‚úàÔ∏è</div>
              <div class="trajectory"></div>
            </div>
          </div>
        </div>
        
        <!-- Controlli scommessa -->
        <div class="bet-controls">
          <div class="bet-amount-controls">
            <label for="bet-amount">Puntata:</label>
            <div class="bet-input-group">
              <button class="bet-btn decrease">-</button>
              <input type="number" id="bet-amount" min="0" max="100" step="0.10" value="0.10">
              <button class="bet-btn increase">+</button>
            </div>
          </div>
          
          <div class="bet-actions">
            <button id="sit-out-button" class="secondary-button">Salta round</button>
            <button id="ready-button" class="action-button">Ready</button>
            <button id="eject-button" class="action-button primary">EJECT</button>
          </div>
          
          <!-- Status del gioco -->
          <div class="game-status">
            <div id="status-message">Waiting for players to join...</div>
            <div id="countdown-timer" class="hidden">Next round in <span id="timer-value">10</span>s</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer con credits e pulsante uscita -->
    <div class="room-footer">
      <div id="player-credits" class="player-credits">
        Your Credits: <span id="credit-amount">10.00</span>
      </div>
      <div class="footer-actions">
        <button id="chat-button" class="secondary-button">Chat</button>
        <button id="leave-room-button">Leave Room</button>
      </div>
    </div>
    
    <!-- Container chat (nascosto per default) -->
    <div id="chat-container" class="hidden">
      <div id="chat-messages"></div>
      <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="Type a message...">
        <button id="send-message-button">Send</button>
      </div>
    </div>
    
    <!-- Risultati round (nascosto per default) -->
    <div class="results-container hidden" id="results-screen">
      <h2>Round Results</h2>
      <div id="crash-point"></div>
      <div id="results-list"></div>
    </div>
  </div>
</div>
    
    <!-- Profile Screen -->
    <div id="profile-screen" class="screen hidden">
      <div class="container">
        <h1>Your Profile</h1>
        <div class="profile-info">
          <div class="profile-header">
            <div class="username-container">
              <div id="profile-username">Username</div>
              <button id="edit-username-button" class="edit-button">
                <span>‚úèÔ∏è</span>
              </button>
            </div>
            <div id="selected-badge">No Badge</div>
          </div>
          <div class="stats-container">
            <div class="stat-item">
              <span class="stat-label">Total Games:</span>
              <span id="total-games" class="stat-value">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Highest Multiplier:</span>
              <span id="highest-multiplier" class="stat-value">1.00x</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Games Won:</span>
              <span id="games-won" class="stat-value">0</span>
            </div>
          </div>
          <div class="badges-container">
            <h2>Your Badges</h2>
            <div id="badges-list"></div>
          </div>
        </div>
        <button id="back-from-profile">Back to Lobby</button>
      </div>
    </div>
  </div>
  
  <script type="module" src="src/client/js/AudioManager.js"></script>
  <script type="module" src="src/client/js/BonusSystem.js"></script>
  <script src="dist/bundle.js"></script>

 <!-- Firebase Authentication -->
<script type="module">
  // Importa Firebase
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js';
  import { 
    getAuth, 
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    sendEmailVerification
  } from 'https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js';

  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCp5Rt67nkZ_DECiyyim3QuBC-Zgq6y1Dw",
    authDomain: "cabincrew-game.firebaseapp.com",
    projectId: "cabincrew-game",
    storageBucket: "cabincrew-game.firebasestorage.app",
    messagingSenderId: "525011831374",
    appId: "1:525011831374:web:ace85fdd1963f62485911f",
    measurementId: "G-6YSD9F2ZHQ"
  };

  // Inizializza Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  document.addEventListener('DOMContentLoaded', function() {
    // Elementi UI
    const loginTab = document.getElementById('login-tab');
    const registerTab = document.getElementById('register-tab');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const switchToRegister = document.getElementById('switch-to-register');
    const switchToLogin = document.getElementById('switch-to-login');
    const loginButton = document.getElementById('login-button');
    const registerButton = document.getElementById('register-button');

    console.log('Firebase Auth script caricato');

    // Funzioni per cambiare form
    function showLoginForm() {
      loginTab.classList.add('active');
      registerTab.classList.remove('active');
      loginForm.classList.remove('hidden');
      registerForm.classList.add('hidden');
      console.log('Login form attivato');
    }

    function showRegisterForm() {
      registerTab.classList.add('active');
      loginTab.classList.remove('active');
      registerForm.classList.remove('hidden');
      loginForm.classList.add('hidden');
      console.log('Registration form attivato');
    }

    // Gestisce la registrazione con verifica username
    async function handleRegister() {
      const username = document.getElementById('register-username').value.trim();
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      const confirmPassword = document.getElementById('register-confirm-password').value;

      console.log('Tentativo di registrazione per:', email);

      // Validazione
      if (!username || !email || !password || !confirmPassword) {
        alert('Compila tutti i campi richiesti');
        return;
      }

      if (password !== confirmPassword) {
        alert('Le password non corrispondono');
        return;
      }
      
      // Disabilita il pulsante di registrazione
      const registerButton = document.getElementById('register-button');
      if (registerButton) {
        registerButton.disabled = true;
        registerButton.textContent = 'Verifico disponibilit√†...';
      }
      
      try {
        // Importa la funzione isUsernameAvailable
        const { isUsernameAvailable, reserveUsername } = await import('/src/client/js/firebaseConfig.js');
        
        // Verifica disponibilit√† username
        const isAvailable = await isUsernameAvailable(username);
        if (!isAvailable) {
          alert('Username gi√† in uso. Scegline un altro.');
          if (registerButton) {
            registerButton.disabled = false;
            registerButton.textContent = 'Registrati';
          }
          return;
        }
        
        console.log('Username disponibile, creazione utente in Firebase...');
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Salva l'username in Firebase
        await reserveUsername(user.uid, username);
        
        // Salva l'username in localStorage persistente
        localStorage.setItem('username_' + user.uid, username);
        console.log('Username salvato:', username, 'per utente', user.uid);
        
        // Invia email di verifica
        console.log('Invio email di verifica...');
        await sendEmailVerification(user);
        
        alert('Registrazione completata! Ti abbiamo inviato un\'email di conferma.');
        showLoginForm();
      } catch (error) {
        console.error('Errore di registrazione:', error);
        alert('Errore di registrazione: ' + error.message);
      } finally {
        // Riabilita il pulsante
        if (registerButton) {
          registerButton.disabled = false;
          registerButton.textContent = 'Registrati';
        }
      }
    }

    // Gestisce il login
    async function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      console.log('Tentativo di login per:', email);

      if (!email || !password) {
        alert('Compila tutti i campi richiesti');
        return;
      }

      try {
        console.log('Login in corso...');
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        if (!user.emailVerified) {
          alert('Per favore verifica la tua email prima di accedere.');
          return;
        }
        
        // Recupera username dal localStorage o usa l'email come fallback
        const savedUsername = localStorage.getItem('username_' + user.uid) || email.split('@')[0];
        
        // Salva i dati utente nella sessione
        sessionStorage.setItem('user', JSON.stringify({
          id: user.uid,
          username: savedUsername,
          email: user.email
        }));
        
        // Reindirizza alla lobby
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('lobby-screen').classList.remove('hidden');
        
        // Aggiorna immediatamente l'UI
        if (typeof updateUserProfile === 'function') {
          updateUserProfile();
        }
      } catch (error) {
        console.error('Errore di login:', error);
        alert('Errore di login: ' + error.message);
      }
    }

    // Collegamenti event listener
    loginTab.onclick = showLoginForm;
    registerTab.onclick = showRegisterForm;
    
    switchToRegister.onclick = function(e) {
      e.preventDefault();
      showRegisterForm();
    };
    
    switchToLogin.onclick = function(e) {
      e.preventDefault();
      showLoginForm();
    };

    // Collega i bottoni auth
    loginButton.addEventListener('click', handleLogin);
    registerButton.addEventListener('click', handleRegister);

    console.log('Event handlers di autenticazione collegati');
  });
  </script>

  <!-- Lobby JavaScript -->
<script>
  // JavaScript per gestire la nuova interfaccia lobby
  document.addEventListener('DOMContentLoaded', function() {
    // Gestione navigazione e azioni
    initLobbyEvents();
    // Inizializza l'interfaccia
    updateUserProfile();
    // Attiva la modifica username
    setTimeout(() => {
      initUsernameEdit();
    }, 300);
  });
 
  function initLobbyEvents() {
    // Profilo utente in alto a destra
    const userProfileCard = document.getElementById('user-profile-card');
    const profileOverlay = document.getElementById('profile-overlay');
    const closeOverlayButtons = document.querySelectorAll('.close-overlay');
    
    // Mostra overlay profilo/amici
    if (userProfileCard) {
      userProfileCard.addEventListener('click', function() {
        if (profileOverlay) profileOverlay.classList.remove('hidden');
      });
    }
    
    // Chiudi overlay
    closeOverlayButtons.forEach(button => {
      button.addEventListener('click', function() {
        const overlay = this.closest('.overlay');
        if (overlay) overlay.classList.add('hidden');
      });
    });
    
    // Tab di navigazione nel profilo
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Rimuovi classe active da tutti i tab
        tabButtons.forEach(btn => btn.classList.remove('active'));
        // Aggiungi classe active al tab cliccato
        this.classList.add('active');
        
        // Nascondi tutti i contenuti tab
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.add('hidden'));
        
        // Mostra il contenuto del tab selezionato
        const tabId = this.getAttribute('data-tab');
        const activeContent = document.getElementById(tabId);
        if (activeContent) activeContent.classList.remove('hidden');
      });
    });
    
    // Gestione pulsanti della lobby
    const createRoomButton = document.getElementById('create-room-button');
    const joinRoomButton = document.getElementById('join-room-button');
    const addFriendButton = document.getElementById('add-friend-button');
    
    if (createRoomButton) {
      createRoomButton.addEventListener('click', function() {
        handleCreateRoom();
      });
    }
    
    if (joinRoomButton) {
      joinRoomButton.addEventListener('click', function() {
        handleJoinRoom();
      });
    }
    
    if (addFriendButton) {
      addFriendButton.addEventListener('click', function() {
        handleAddFriend();
      });
    }
    
    // Gestione eventi escape per chiudere gli overlay
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const overlays = document.querySelectorAll('.overlay:not(.hidden)');
        overlays.forEach(overlay => overlay.classList.add('hidden'));
      }
    });
  }
 
  // Aggiorna le informazioni del profilo utente dall'autenticazione
  function updateUserProfile() {
    const user = getLoggedInUser();
    console.log('Dati utente:', user);
    
    if (!user) return;
    
    // Aggiorna tutti i display del nome utente
    const usernameDisplay = document.getElementById('username-display');
    if (usernameDisplay) usernameDisplay.textContent = user.username;
    
    // Aggiorna l'username nella schermata profilo
    const profileUsername = document.getElementById('profile-username');
    if (profileUsername) profileUsername.textContent = user.username;
    
    // Aggiorna l'username nel tab profilo dell'overlay
    const profileTabUsername = document.getElementById('profile-tab-username');
    if (profileTabUsername) profileTabUsername.textContent = user.username;
    
    // Carica i badge dell'utente
    loadUserBadges();
}
 
  // Ottieni l'utente attualmente loggato
  function getLoggedInUser() {
    const userData = sessionStorage.getItem('user');
    return userData ? JSON.parse(userData) : null;
  }
 
  // Gestione creazione stanza
  function handleCreateRoom() {
    const roomName = document.getElementById('room-name').value;
    const roomCode = document.getElementById('room-code').value;
    const initialCredits = document.getElementById('initial-credits').value;
    const roundCount = document.getElementById('round-count').value;
    
    // Validazione
    if (!roomName || !roomCode) {
      alert('Per favore inserisci il nome e il codice della stanza');
      return;
    }
    
    // Socket.IO deve essere connesso all'inizio dello script
    const socket = io();
    
    // Emetti evento per creare la stanza
    socket.emit('createRoom', {
      name: roomName,
      code: roomCode,
      initialCredits,
      roundCount
    });
    
    // Ascolta la risposta del server
    socket.on('roomCreated', (room) => {
      console.log('Stanza creata:', room);
      
      // Passa alla schermata di gioco
      document.getElementById('lobby-screen').classList.add('hidden');
      document.getElementById('game-room-screen').classList.remove('hidden');
      
      // Aggiorna UI
      document.getElementById('room-title').textContent = room.name;
      document.getElementById('room-code-display').textContent = 'Code: ' + room.code;
      document.getElementById('round-info').textContent = 'Round 0/' + room.roundCount;
      document.getElementById('credit-amount').textContent = room.initialCredits;
    });
    
    socket.on('roomError', (error) => {
      alert(error.message);
    });
  }
 
  // Gestione partecipazione stanza
  function handleJoinRoom() {
    const roomCode = document.getElementById('join-room-code').value;
    
    if (!roomCode) {
      alert('Per favore inserisci il codice della stanza');
      return;
    }
    
    // Socket.IO deve essere connesso all'inizio dello script
    const socket = io();
    
    // Emetti evento per unirsi alla stanza
    socket.emit('joinRoom', { code: roomCode });
    
    // Ascolta la risposta del server
    socket.on('roomJoined', (room) => {
      console.log('Unito alla stanza:', room);
      
      // Passa alla schermata di gioco
      document.getElementById('lobby-screen').classList.add('hidden');
      document.getElementById('game-room-screen').classList.remove('hidden');
      
      // Aggiorna UI
      document.getElementById('room-title').textContent = room.name;
      document.getElementById('room-code-display').textContent = 'Code: ' + room.code;
      document.getElementById('round-info').textContent = 'Round 0/' + room.roundCount;
      document.getElementById('credit-amount').textContent = room.initialCredits;
    });
    
    socket.on('roomError', (error) => {
      alert(error.message);
    });
  }
 
  // Gestione aggiunta amici
  function handleAddFriend() {
    const friendUsername = document.getElementById('friend-search').value;
    
    if (!friendUsername) {
      alert('Per favore inserisci un nome utente da cercare');
      return;
    }
    
    // Simula la ricerca di un amico
    console.log('Ricerca utente:', friendUsername);
    
    // Simulazione di un'aggiunta amico riuscita
    alert('Richiesta di amicizia inviata a ' + friendUsername);
    document.getElementById('friend-search').value = '';
    
    // Aggiorna la lista amici (simulazione)
    const friendsContainer = document.getElementById('friends-container');
    const noFriendsMessage = document.querySelector('.no-friends-message');
    
    if (noFriendsMessage) {
      noFriendsMessage.remove();
    }
    
    const friendElement = document.createElement('div');
    friendElement.className = 'friend-item';
    friendElement.innerHTML = `
      <div class="friend-info">
        <div class="friend-avatar">üë§</div>
        <div class="friend-username">${friendUsername}</div>
      </div>
      <div class="friend-actions">
        <button class="friend-action-btn">Message</button>
      </div>
    `;
    
    if (friendsContainer) {
      friendsContainer.appendChild(friendElement);
    }
  }
  
  // Funzionalit√† per la modifica dello username
  function initUsernameEdit() {
    const editButton = document.getElementById('edit-username-button');
    const editButtonOverlay = document.getElementById('edit-username-button-overlay');
    const modal = document.getElementById('edit-username-modal');
    
    if (!modal) {
      console.error('Modal per la modifica username non trovato');
      return;
    }
    
    const closeButton = modal.querySelector('.close-modal');
    const saveButton = document.getElementById('save-username-button');
    
    // Funzione per aprire il modal
    function openEditModal() {
      const user = getLoggedInUser();
      if (user) {
        document.getElementById('new-username').value = user.username;
        modal.classList.remove('hidden');
      }
    }
    
    // Aggiungi event listener al bottone nella schermata profilo
    if (editButton) {
      editButton.addEventListener('click', function(e) {
        e.stopPropagation(); // Previene la propagazione dell'evento click
        openEditModal();
      });
    }
    
    // Aggiungi event listener al bottone nell'overlay
    if (editButtonOverlay) {
      editButtonOverlay.addEventListener('click', function(e) {
        e.stopPropagation(); // Previene la propagazione dell'evento click
        openEditModal();
      });
    }
    
    // Chiudi modal
    if (closeButton) {
      closeButton.addEventListener('click', function() {
        modal.classList.add('hidden');
      });
    }
    
    // Salva nuovo username (versione semplificata)
    if (saveButton) {
      saveButton.addEventListener('click', function() {
        const newUsername = document.getElementById('new-username').value.trim();
        
        if (!newUsername) {
          alert('Inserisci un username valido');
          return;
        }
        
        // Ottieni utente corrente
        const user = getLoggedInUser();
        if (!user) return;
        
        // Disabilita il pulsante durante la verifica
        saveButton.disabled = true;
        saveButton.textContent = 'Salvataggio...';
        
        // Se l'username √® uguale a quello attuale, non serve modificare
        if (user.username === newUsername) {
          // Chiudi modal
          modal.classList.add('hidden');
          saveButton.disabled = false;
          saveButton.textContent = 'Salva';
          return;
        }
        
        // Aggiorna username nei dati locali
        console.log('Aggiornamento username:', user.username, '->', newUsername);
        
        try {
          // Aggiorna localStorage e sessionStorage
          localStorage.setItem('username_' + user.id, newUsername);
          
          const updatedUser = {
            ...user,
            username: newUsername
          };
          
          sessionStorage.setItem('user', JSON.stringify(updatedUser));
          
          // Aggiorna tutti gli elementi UI
          const profileUsername = document.getElementById('profile-username');
          if (profileUsername) profileUsername.textContent = newUsername;
          
          const profileTabUsername = document.getElementById('profile-tab-username');
          if (profileTabUsername) profileTabUsername.textContent = newUsername;
          
          const usernameDisplay = document.getElementById('username-display');
          if (usernameDisplay) usernameDisplay.textContent = newUsername;
          
          // Nota: La funzionalit√† Firebase per verificare l'unicit√† dell'username
          // √® stata temporaneamente disattivata per motivi di compatibilit√†.
          // In una versione futura, potrebbe essere implementata tramite 
          // un endpoint del server o una Cloud Function.
          
          console.log('Username aggiornato con successo in locale');
          
          // Chiudi modal
          modal.classList.add('hidden');
        } catch (error) {
          console.error('Errore nell\'aggiornamento dell\'username:', error);
          alert('Si √® verificato un errore durante il salvataggio dell\'username');
        } finally {
          // Riabilita il pulsante
          saveButton.disabled = false;
          saveButton.textContent = 'Salva';
        }
      });
    }
    
    // Chiudi con Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
      }
    });
    
    console.log('Inizializzazione pulsanti modifica username completata');
  }
  // I badge vengono ora gestiti dal badge manager
  // Questa sezione √® obsoleta e verr√† rimossa in una prossima versione

// Le funzioni relative ai badge sono state spostate nel modulo badgeManager.js
// Queste funzioni sono mantenute qui temporaneamente per la retrocompatibilit√†, 
// ma verranno rimosse in una versione futura

// Funzione per caricare i badge dell'utente
async function loadUserBadges() {
  // Importa solo se necessario (il profilo ora gestisce questo autonomamente)
  try {
    const badgeManager = await import('/src/client/js/badgeManager.js');
    const user = getLoggedInUser();
    if (!user) return;
    
    // Aggiorna l'icona del badge selezionato
    const { badges, selectedBadge } = await badgeManager.default.getUserBadges(user.id || user.uid);
    
    if (selectedBadge) {
      const badgeInfo = badgeManager.default.getBadgeInfo(selectedBadge);
      if (badgeInfo && badgeInfo.image) {
        const badgeIcon = document.getElementById('selected-badge-icon');
        if (badgeIcon) {
          badgeIcon.src = badgeInfo.image;
        }
      }
    }
  } catch (error) {
    console.error('Errore nel caricamento dei badge:', error);
  }
}

// Funzione per selezionare un badge (mantenuta per retrocompatibilit√†)
async function selectBadge(badgeId) {
  try {
    const badgeManager = await import('/src/client/js/badgeManager.js');
    const user = getLoggedInUser();
    if (!user) return;
    
    await badgeManager.default.selectBadge(user.id || user.uid, badgeId);
    
    // Aggiorna l'interfaccia
    const badgeInfo = badgeManager.default.getBadgeInfo(badgeId);
    if (badgeInfo && badgeInfo.image) {
      const badgeIcon = document.getElementById('selected-badge-icon');
      if (badgeIcon) {
        badgeIcon.src = badgeInfo.image;
      }
    }
    
    // Aggiorna anche la sessione locale
    const userData = JSON.parse(sessionStorage.getItem('user'));
    if (userData) {
      userData.selectedBadge = badgeId;
      sessionStorage.setItem('user', JSON.stringify(userData));
    }
  } catch (error) {
    console.error('Errore nella selezione del badge:', error);
  }
}
 </script>
  <script>
    // Test audio da aggiungere a index.html
    document.addEventListener('DOMContentLoaded', function() {
      // Crea un pannello di test audio
      const testDiv = document.createElement('div');
      testDiv.style.position = 'fixed';
      testDiv.style.bottom = '20px';
      testDiv.style.right = '20px';
      testDiv.style.background = 'rgba(0,0,0,0.8)';
      testDiv.style.color = 'white';
      testDiv.style.padding = '10px';
      testDiv.style.borderRadius = '5px';
      testDiv.style.zIndex = '9999';
      testDiv.innerHTML = `
        <div>Test Audio</div>
        <button id="test-menu-music">Menu Music</button>
        <button id="test-game-music">Game Music</button>
        <button id="test-stop">Stop</button>
        <div id="test-status">Stato: in attesa</div>
      `;
      
      document.body.appendChild(testDiv);
      
      // Funzione per testare un file audio specifico
      function testAudio(src) {
        console.log(`Test audio: ${src}`);
        const audio = new Audio(src);
        audio.volume = 0.3;
        
        // Riproduci con gestione errori
        audio.play()
          .then(() => {
            console.log('Audio avviato con successo');
            document.getElementById('test-status').textContent = `Riproduzione: ${src}`;
          })
          .catch(error => {
            console.error(`Errore riproduzione ${src}:`, error);
            document.getElementById('test-status').textContent = `Errore: ${error.message}`;
          });
          
        return audio;
      }
      
      // Riferimenti agli elementi audio
      let menuAudio = null;
      let gameAudio = null;
      
      // Aggiungi event listener
      document.getElementById('test-menu-music').addEventListener('click', () => {
        if (menuAudio) menuAudio.pause();
        if (gameAudio) gameAudio.pause();
        menuAudio = testAudio('/assets/audio/menu-music.mp3');
      });
      
      document.getElementById('test-game-music').addEventListener('click', () => {
        if (menuAudio) menuAudio.pause();
        if (gameAudio) gameAudio.pause();
        gameAudio = testAudio('/assets/audio/game-track-1.mp3');
      });
      
      document.getElementById('test-stop').addEventListener('click', () => {
        if (menuAudio) {
          menuAudio.pause();
          menuAudio = null;
        }
        if (gameAudio) {
          gameAudio.pause();
          gameAudio = null;
        }
        document.getElementById('test-status').textContent = 'Audio fermato';
      });
    });
  </script>
 <script>
  // Script corretto per gestire il pulsante mute
  document.addEventListener('DOMContentLoaded', function() {
    // Rimuovi pannello test
    const testPanels = document.querySelectorAll('div[style*="position: fixed"][style*="bottom: 20px"][style*="right: 20px"]');
    testPanels.forEach(panel => panel.remove());
    
    // Gestione audio
    let audioContext;
    let audioElements = [];
    let isMuted = false;
    
    function toggleMute() {
      isMuted = !isMuted;
      
      // Trova tutti gli elementi audio
      audioElements = document.querySelectorAll('audio');
      
      // Applica mute/unmute
      audioElements.forEach(audio => {
        audio.muted = isMuted;
      });
      
      // Aggiorna UI
      const muteButton = document.getElementById('mute-button');
      if (muteButton) {
        if (isMuted) {
          muteButton.classList.add('muted');
        } else {
          muteButton.classList.remove('muted');
        }
      }
      
      console.log('Audio ' + (isMuted ? 'disattivato' : 'attivato'));
      return isMuted;
    }
    
    // Collega evento click
    const muteButton = document.getElementById('mute-button');
    if (muteButton) {
      muteButton.addEventListener('click', function() {
        toggleMute();
        
        // Prova anche ad accedere all'AudioManager
        try {
          const audioManagerScript = document.createElement('script');
          audioManagerScript.textContent = `
            if (typeof audioManager !== 'undefined') {
              audioManager.isMuted = ${isMuted};
              if (${isMuted}) {
                audioManager.stopMenuMusic();
                audioManager.stopGameMusic();
              } else {
                audioManager.playMenuMusic();
              }
            }
          `;
          document.head.appendChild(audioManagerScript);
          document.head.removeChild(audioManagerScript);
        } catch (err) {
          console.error('Errore accesso AudioManager:', err);
        }
      });
    }
  });
</script>

<!-- Modal per modificare l'username -->
<div id="edit-username-modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Modifica Username</h3>
      <button class="close-modal">√ó</button>
    </div>
    <div class="modal-body">
      <input type="text" id="new-username" placeholder="Nuovo username">
      <button id="save-username-button" class="primary-button">Salva</button>
    </div>
  </div>
</div>

  <script>
    // Script per l'animazione dell'aereo e del moltiplicatore
    document.addEventListener('DOMContentLoaded', function() {
      // Funzione per aggiornare il moltiplicatore e l'animazione
      function updateMultiplierDisplay(value) {
        const multiplierElement = document.getElementById('multiplier-display');
        const airplane = document.querySelector('.airplane');
        const trajectory = document.querySelector('.trajectory');
        
        // Aggiorna il testo del moltiplicatore
        multiplierElement.textContent = value.toFixed(2) + 'x';
        
        // Cambia colore in base al valore
        multiplierElement.classList.remove('medium', 'high');
        if (value >= 10) {
          multiplierElement.classList.add('high');
        } else if (value >= 2) {
          multiplierElement.classList.add('medium');
        }
        
        // Calcola la posizione dell'aereo (movimento esponenziale)
        const progress = Math.min((value - 1) / 9, 1); // da 1x a 10x mappato da 0 a 1
        const curveProgress = Math.pow(progress, 0.8); // funzione esponenziale per la curva
        
        // Posiziona l'aereo
        const left = 10 + (curveProgress * 70); // da 10% a 80% orizzontalmente
        const bottom = 10 + (curveProgress * 70); // da 10% a 80% verticalmente
        
        airplane.style.left = `${left}%`;
        airplane.style.bottom = `${bottom}%`;
        
        // Aggiorna la traiettoria
        trajectory.style.width = `${left - 10}%`;
        trajectory.style.height = `${bottom - 10}%`;
        trajectory.style.transform = `rotate(${Math.atan2(bottom - 10, left - 10) * (180 / Math.PI)}deg)`;
      }
      
      // Testa l'animazione quando la game room diventa visibile
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            const gameRoom = document.getElementById('game-room-screen');
            if (gameRoom && !gameRoom.classList.contains('hidden')) {
              // Inizializza il moltiplicatore
              updateMultiplierDisplay(1.00);
              
              // Per test: simula la crescita del moltiplicatore
              const testButton = document.getElementById('eject-button');
              if (testButton) {
                testButton.addEventListener('click', function() {
                  // Simuliamo una crescita del moltiplicatore per testare l'animazione
                  let value = 1.00;
                  const interval = setInterval(() => {
                    value += 0.05;
                    updateMultiplierDisplay(value);
                    if (value > 15) clearInterval(interval);
                  }, 100);
                });
              }
            }
          }
        });
      });
      
      const gameRoom = document.getElementById('game-room-screen');
      if (gameRoom) {
        observer.observe(gameRoom, { attributes: true });
      }
    });
    </script>
    <script src="fix-game-room.js"></script>
    <script src="debug-game.js"></script>

    <script>
      // Inizializza correttamente la game room
      document.addEventListener('DOMContentLoaded', function() {
        // Corregge i problemi di visualizzazione della game room
        const socket = io();
        
        // Evento di creazione stanza
        socket.on('roomCreated', function(room) {
          // Rimuovi classe hidden
          document.getElementById('game-room-screen').classList.remove('hidden');
          
          // Assicurati che il video di background sia nascosto
          document.querySelector('.background-video-container').style.display = 'none';
          
          // Imposta i dati della stanza
          document.getElementById('room-title').textContent = room.name;
          document.getElementById('room-code-display').textContent = 'Code: ' + room.code;
          document.getElementById('round-info').textContent = 'Round 0/' + room.roundCount;
        });
        
        // Lo stesso per l'evento join room
        socket.on('roomJoined', function(room) {
          // Rimuovi classe hidden
          document.getElementById('game-room-screen').classList.remove('hidden');
          
          // Assicurati che il video di background sia nascosto
          document.querySelector('.background-video-container').style.display = 'none';
          
          // Imposta i dati della stanza
          document.getElementById('room-title').textContent = room.name;
          document.getElementById('room-code-display').textContent = 'Code: ' + room.code;
          document.getElementById('round-info').textContent = 'Round 0/' + room.roundCount;
        });
      });
    </script>
</body>
</html>